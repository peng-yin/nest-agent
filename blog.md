# ä»é›¶æ­å»ºå¤š Agent æ™ºèƒ½ç¼–æ’å¹³å°ï¼šNestJS + LangGraph å…¨æ ˆå®æˆ˜

> æœ¬æ–‡åˆ†äº«ä¸€ä¸ªå¼€æºé¡¹ç›® **Nest-Agent**â€”â€”åŸºäº NestJS + LangGraph æ„å»ºçš„å¤š Agent ç¼–æ’å¹³å°ï¼Œæ”¯æŒ Supervisor è‡ªåŠ¨è·¯ç”±ã€DAG è‡ªå®šä¹‰å·¥ä½œæµã€RAG çŸ¥è¯†åº“æ£€ç´¢ï¼Œéµå¾ª AG-UI æ ‡å‡†åè®®å®ç° token çº§æµå¼è¾“å‡ºã€‚å¦‚æœå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ [GitHub Star](https://github.com/peng-yin/nest-agent) æ”¯æŒ â­

---

## ä¸ºä»€ä¹ˆåšè¿™ä¸ªé¡¹ç›®ï¼Ÿ

å½“å‰ AI Agent æ¡†æ¶å±‚å‡ºä¸ç©·ï¼ŒPython ç”Ÿæ€çš„ LangChainã€CrewAI å·²ç»å¾ˆæˆç†Ÿã€‚ä½†åœ¨ Node.js / TypeScript ç”Ÿæ€ï¼Œ**ä¼ä¸šçº§çš„ Agent ç¼–æ’åç«¯æ–¹æ¡ˆ**ç›¸å¯¹åŒ®ä¹ã€‚ä½œä¸ºä¸€ä¸ª NestJS çˆ±å¥½è€…ï¼Œæˆ‘å¸Œæœ›ç”¨æœ€ç†Ÿæ‚‰çš„æŠ€æœ¯æ ˆæ‰“é€ ä¸€ä¸ªï¼š

- **ç”Ÿäº§çº§**çš„å¤š Agent ååŒå¹³å°ï¼Œä¸æ˜¯ demo
- æ”¯æŒ **Supervisor è‡ªåŠ¨è·¯ç”±** å’Œ **DAG è‡ªå®šä¹‰å·¥ä½œæµ** ä¸¤ç§ç¼–æ’æ¨¡å¼
- éµå¾ª **AG-UI æ ‡å‡†åè®®**ï¼Œå‰åç«¯è§£è€¦ï¼Œå¯å¯¹æ¥ CopilotKit ç­‰ä¸»æµå‰ç«¯ SDK
- å†…ç½® **RAG çŸ¥è¯†åº“**ã€**å¤š LLM ä¾›åº”å•†**ã€**å¤šç§Ÿæˆ·éš”ç¦»**ï¼Œå¼€ç®±å³ç”¨

äºæ˜¯æœ‰äº† **Nest-Agent**ã€‚

---

## æŠ€æœ¯æ ˆä¸€è§ˆ

| å±‚æ¬¡ | æŠ€æœ¯ |
|------|------|
| åç«¯æ¡†æ¶ | NestJS 11 |
| Agent ç¼–æ’ | LangChain + LangGraph |
| æ•°æ®åº“ | MySQL 8.0 (TypeORM) |
| ç¼“å­˜ | Redis 7 (ioredis) |
| å‘é‡åº“ | Milvus 2.3 |
| è®¤è¯ | Passport JWT |
| å‰ç«¯ | React 18 + shadcn/ui + Vite |
| åŒ…ç®¡ç† | pnpm workspace (monorepo) |
| éƒ¨ç½² | Docker Compose ä¸€é”®å¯åŠ¨ |

---

## æ ¸å¿ƒåŠŸèƒ½å±•ç¤º

### 1. AI å¯¹è¯ â€” æµå¼è¾“å‡º + å·¥å…·è°ƒç”¨å¯è§†åŒ–

å¯¹è¯æ˜¯æ•´ä¸ªå¹³å°çš„æ ¸å¿ƒã€‚è¾“å…¥ä¸€ä¸ªé—®é¢˜ï¼ŒSupervisor è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æœç´¢ã€æ£€ç´¢çŸ¥è¯†åº“è¿˜æ˜¯ç›´æ¥å›ç­”ï¼Œæ•´ä¸ªè¿‡ç¨‹å®æ—¶æµå¼å±•ç¤ºã€‚

![å¯¹è¯é¦–é¡µ](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/chat-home.png)

![æµå¼è¾“å‡º](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/chat-streaming.png)

**äº®ç‚¹ï¼š**
- Token çº§åˆ«çš„æµå¼è¾“å‡ºï¼Œé€å­—æ˜¾ç¤º AI å›å¤
- å®æ—¶å±•ç¤º Agent æ‰§è¡Œæ­¥éª¤ï¼ˆresearcher â†’ æœç´¢ â†’ ç”Ÿæˆå›ç­”ï¼‰
- å·¥å…·è°ƒç”¨å…¨ç¨‹å¯è§†åŒ–â€”â€”å·¥å…·åã€å‚æ•°ã€è¿”å›ç»“æœä¸€ç›®äº†ç„¶
- Markdown å¯Œæ–‡æœ¬æ¸²æŸ“ï¼ˆä»£ç å—ã€è¡¨æ ¼ã€åˆ—è¡¨ã€é“¾æ¥ç­‰ï¼‰
- å¯¹è¯æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆï¼Œä¸å†æ˜¯åƒç¯‡ä¸€å¾‹çš„ "New Conversation"

![å¯¹è¯è¯¦æƒ…](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/chat-conversation.png)

### 2. å·¥ä½œæµç¼–æ’ â€” å¯è§†åŒ– DAG å·¥ä½œæµ

é™¤äº† Supervisor è‡ªåŠ¨æ¨¡å¼ï¼Œä½ è¿˜å¯ä»¥è‡ªå®šä¹‰ DAG å·¥ä½œæµï¼Œç²¾ç¡®æ§åˆ¶ Agent çš„æ‰§è¡Œæµç¨‹ã€‚

![å·¥ä½œæµåˆ—è¡¨](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/workflow-list.png)

![åˆ›å»ºå·¥ä½œæµ](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/workflow-create.png)

**æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹ï¼š**
- `agent` â€” å¯è°ƒç”¨å·¥å…·çš„ AI Agentï¼Œæ”¯æŒè‡ªå®šä¹‰ system prompt
- `tool` â€” ç›´æ¥è°ƒç”¨å·¥å…·èŠ‚ç‚¹
- `condition` â€” æ¡ä»¶åˆ†æ”¯ï¼Œæ ¹æ®å…³é”®è¯è·¯ç”±åˆ°ä¸åŒåˆ†æ”¯
- `start` / `end` â€” èµ·æ­¢æ ‡è®°

### 3. RAG çŸ¥è¯†åº“ â€” è¯­ä¹‰æ£€ç´¢

ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“ï¼ŒAgent å¯¹è¯æ—¶è‡ªåŠ¨æ£€ç´¢ç›¸å…³çŸ¥è¯†ç‰‡æ®µï¼Œå®ç°åŸºäºç§æœ‰æ•°æ®çš„é—®ç­”ã€‚

![çŸ¥è¯†åº“åˆ—è¡¨](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/knowledge-list.png)

![è¯­ä¹‰æ£€ç´¢](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/knowledge-search.png)

**RAG Pipelineï¼š**
```
æ–‡æ¡£ â†’ åˆ†å—(1000/200) â†’ BAAI/bge-m3 Embedding â†’ Milvus å‘é‡å­˜å‚¨
æŸ¥è¯¢ â†’ Embedding â†’ Milvus ANN æ£€ç´¢ â†’ Top-K ç»“æœ
```

### 4. è®¤è¯ç³»ç»Ÿ â€” å¤šç§Ÿæˆ·éš”ç¦»

![ç™»å½•](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/login.png)
![æ³¨å†Œ](https://raw.githubusercontent.com/peng-yin/nest-agent/main/docs/screenshots/register.png)

JWT è®¤è¯ + TenantGuardï¼Œæ‰€æœ‰æ•°æ®æŒ‰ `tenantId` éš”ç¦»ï¼Œå¤©ç„¶æ”¯æŒå¤šå›¢é˜Ÿä½¿ç”¨ã€‚

---

## æ¶æ„è®¾è®¡

### æ•´ä½“åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     React + shadcn/ui                         â”‚
â”‚                (SSE å®¢æˆ·ç«¯ + AG-UI äº‹ä»¶è§£æ)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP POST + SSE æµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NestJS åº”ç”¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Auth â”‚ â”‚ Chat â”‚ â”‚ Agent â”‚ â”‚ RAG  â”‚  Controller å±‚          â”‚
â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜                       â”‚
â”‚     â”‚        â”‚         â”‚        â”‚                             â”‚
â”‚  â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”                       â”‚
â”‚  â”‚ Auth â”‚ â”‚ Chat â”‚ â”‚Agent  â”‚ â”‚ RAG  â”‚  Service å±‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                        â”‚                                      â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                   â”‚
â”‚     â”‚ Supervisor â”‚ â”‚   DAG   â”‚ â”‚  Tool   â”‚  æ ¸å¿ƒç¼–æ’å±‚        â”‚
â”‚     â”‚  Factory   â”‚ â”‚ Engine  â”‚ â”‚Registry â”‚                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚     â”‚   LLM   â”‚ â”‚ Milvus â”‚ â”‚ Redis  â”‚  åŸºç¡€è®¾æ–½å±‚            â”‚
â”‚     â”‚ Service  â”‚ â”‚Service â”‚ â”‚Service â”‚                       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”
    â”‚OpenAI/  â”‚  â”‚ Milvus   â”‚ â”‚Redis â”‚  å­˜å‚¨å±‚
    â”‚Anthropicâ”‚  â”‚ 2.3      â”‚ â”‚  7   â”‚
    â”‚/Qwen    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸¤ç§ç¼–æ’æ¨¡å¼å¯¹æ¯”

#### Supervisor æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

é€‚åˆé€šç”¨å¯¹è¯åœºæ™¯ã€‚LLM å……å½“"ä¸»ç®¡"ï¼Œæ ¹æ®ç”¨æˆ·æ„å›¾åŠ¨æ€è·¯ç”±åˆ°åˆé€‚çš„ Agentï¼š

```
ç”¨æˆ·: "æœç´¢ä¸€ä¸‹ NestJS 11 æ–°åŠŸèƒ½"
  â†’ Supervisor åˆ¤æ–­: éœ€è¦æœç´¢ï¼Œè·¯ç”±åˆ° researcher
  â†’ researcher è°ƒç”¨ web_search å·¥å…·
  â†’ researcher æ ¹æ®æœç´¢ç»“æœç”Ÿæˆå›ç­”
  â†’ Supervisor åˆ¤æ–­: ä»»åŠ¡å®Œæˆï¼Œè·¯ç”±åˆ° __end__
```

æ ¸å¿ƒå®ç°ï¼šSupervisor ä½¿ç”¨ LLM + `withStructuredOutput(zod schema)` åšç»“æ„åŒ–è¾“å‡ºï¼Œè¿”å› `{ next: "researcher" | "responder" | "__end__" }`ã€‚

#### DAG æ¨¡å¼ï¼ˆè‡ªå®šä¹‰å·¥ä½œæµï¼‰

é€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹ã€‚ç”¨æˆ·é¢„å®šä¹‰æœ‰å‘æ— ç¯å›¾ï¼Œç²¾ç¡®æ§åˆ¶æ‰§è¡Œé“¾è·¯ï¼š

```
Start â†’ ç ”ç©¶å‘˜Agent(è°ƒç”¨æœç´¢) â†’ æ¡ä»¶åˆ¤æ–­ â†’ å†™æ‰‹Agent(ç”ŸæˆæŠ¥å‘Š) â†’ End
                                    â†˜ å·¥å…·èŠ‚ç‚¹(ç›´æ¥æ£€ç´¢) â†—
```

æ ¸å¿ƒå®ç°ï¼šå°† JSON æ ¼å¼çš„ `nodes[]` + `edges[]` ç¼–è¯‘ä¸º LangGraph çš„ `StateGraph`ï¼Œé€šè¿‡ `Command({ goto, update })` æ§åˆ¶çŠ¶æ€è½¬ç§»ã€‚

---

## å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. AG-UI æµå¼äº‹ä»¶åè®®

è¿™æ˜¯é¡¹ç›®ä¸­æœ€å¤æ‚ä¹Ÿæœ€æœ‰ä»·å€¼çš„éƒ¨åˆ†ã€‚ç³»ç»Ÿéµå¾ª [AG-UI](https://docs.ag-ui.com) æ ‡å‡†åè®®ï¼Œé€šè¿‡ SSE æ¨é€ç»†ç²’åº¦äº‹ä»¶ï¼š

```
event: RUN_STARTED
data: {"type":"RUN_STARTED","threadId":"xxx","runId":"xxx"}

event: STEP_STARTED
data: {"type":"STEP_STARTED","stepName":"researcher"}

event: TOOL_CALL_START
data: {"type":"TOOL_CALL_START","toolCallId":"xxx","toolCallName":"web_search"}

event: TEXT_MESSAGE_CONTENT
data: {"type":"TEXT_MESSAGE_CONTENT","messageId":"xxx","delta":"é€å­—è¾“å‡º..."}

event: RUN_FINISHED
data: {"type":"RUN_FINISHED","threadId":"xxx","runId":"xxx"}
```

**ä¸‰æ®µå¼æ–‡æœ¬æ¶ˆæ¯**ï¼š`TEXT_MESSAGE_START â†’ TEXT_MESSAGE_CONTENT(å¢é‡) â†’ TEXT_MESSAGE_END`

**å››æ®µå¼å·¥å…·è°ƒç”¨**ï¼š`TOOL_CALL_START â†’ TOOL_CALL_ARGS â†’ TOOL_CALL_END â†’ TOOL_CALL_RESULT`

éµå¾ªæ ‡å‡†åè®®æ„å‘³ç€å¯ä»¥ç›´æ¥å¯¹æ¥ CopilotKit ç­‰å‰ç«¯ SDKï¼Œæ— éœ€è‡ªå®šä¹‰è§£æã€‚

### 2. LangGraph streamEvents â†’ AG-UI çš„ç²¾ç»†è½¬æ¢

`AgentService.processStreamEvents()` æ–¹æ³•å®ç°äº† LangGraph åº•å±‚äº‹ä»¶åˆ° AG-UI åè®®çš„æ˜ å°„ï¼Œéœ€è¦å¤„ç†å‡ ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼š

**é—®é¢˜ 1ï¼šSupervisor è·¯ç”±èŠ‚ç‚¹çš„è¾“å‡ºä¸åº”æš´éœ²ç»™ç”¨æˆ·**

Supervisor çš„ç»“æ„åŒ–è¾“å‡ºï¼ˆ`{ next: "researcher" }`ï¼‰æ˜¯å†…éƒ¨è·¯ç”±å†³ç­–ï¼Œä¸åº”è¯¥æ¨é€ç»™å‰ç«¯ã€‚é€šè¿‡èŠ‚ç‚¹åè¿‡æ»¤è§£å†³ã€‚

**é—®é¢˜ 2ï¼šåµŒå¥—å­ Agent çš„"æ€è€ƒ"æ–‡æœ¬**

`createReactAgent` å†…éƒ¨çš„ LLM åœ¨è°ƒç”¨å·¥å…·å‰ä¼šè¾“å‡ºä¸€äº›"æ€è€ƒ"æ–‡æœ¬ï¼ˆé€šå¸¸æ˜¯å¤è¿° promptï¼‰ï¼Œè¿™äº›ä¸åº”æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡ `langgraph_checkpoint_ns` åŒºåˆ†åµŒå¥—å±‚çº§ï¼š

```typescript
const isNestedAgent = parentNode && langgraphNode !== parentNode;
if (isNestedAgent && !nodeToolsDone.get(nodeKey)) {
  // æš‚å­˜åˆ° pendingTextPerNodeï¼Œå·¥å…·å®Œæˆåæ‰é‡Šæ”¾
}
```

**é—®é¢˜ 3ï¼šXML å·¥å…·è°ƒç”¨æ ¼å¼å…¼å®¹**

æŸäº›æ¨¡å‹ï¼ˆå¦‚ qwenï¼‰ä¼šä»¥ `<tool_call>` XML æ ‡ç­¾è¾“å‡ºå·¥å…·è°ƒç”¨ã€‚ä»£ç ä½¿ç”¨æ­£åˆ™æ£€æµ‹å¹¶è¿‡æ»¤ï¼Œé¿å… XML æ ‡ç­¾æ³„éœ²åˆ°å‰ç«¯ã€‚

### 3. æ™ºèƒ½è®°å¿†ç®¡ç†

å¯¹è¯è®°å¿†é‡‡ç”¨ **æ»‘åŠ¨çª—å£ + LLM è‡ªåŠ¨æ‘˜è¦** çš„æ··åˆç­–ç•¥ï¼š

```
æ¶ˆæ¯æ•° â‰¤ 10        â†’ å…¨é‡è¿”å›ï¼Œæ— å‹ç¼©
10 < æ¶ˆæ¯æ•° â‰¤ 20   â†’ æ»‘åŠ¨çª—å£ï¼Œå–æœ€è¿‘ 10 æ¡
æ¶ˆæ¯æ•° > 20        â†’ LLM å¯¹æ—©æœŸæ¶ˆæ¯ç”Ÿæˆæ‘˜è¦ï¼Œæ‘˜è¦ + æœ€è¿‘ 10 æ¡
```

æ‘˜è¦å­˜å‚¨åœ¨ `Conversation.summary` å­—æ®µï¼Œæ”¯æŒå¢é‡æ‘˜è¦ï¼ˆæ–°å¯¹è¯å†…å®¹è¿½åŠ åˆ°ç°æœ‰æ‘˜è¦ä¸Šï¼‰ã€‚ä¼šè¯æ¶ˆæ¯ç¼“å­˜åœ¨ Redisï¼ŒTTL 3600 ç§’ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ã€‚

### 4. å¤š LLM ä¾›åº”å•†æŠ½è±¡

ç»Ÿä¸€çš„æ¨¡å‹å·¥å‚ï¼Œåˆ‡æ¢ä¾›åº”å•†åªéœ€ä¸€ä¸ªå‚æ•°ï¼š

```typescript
// ç”¨æˆ·è¯·æ±‚æ—¶æŒ‡å®š
{ llmOptions: { provider: "openai", model: "gpt-4o" } }
{ llmOptions: { provider: "dashscope", model: "qwen-max" } }
{ llmOptions: { provider: "anthropic", model: "claude-sonnet-4-20250514" } }
```

DashScopeï¼ˆé€šä¹‰åƒé—®ï¼‰é€šè¿‡ OpenAI å…¼å®¹åè®®æ¥å…¥ï¼Œè‡ªå®šä¹‰ `baseURL` å³å¯ã€‚åŒæ ·çš„æ–¹å¼å¯ä»¥æ¥å…¥ SiliconFlowã€Deepseekã€vLLM ç­‰ä»»ä½•å…¼å®¹ OpenAI API çš„æœåŠ¡ã€‚

### 5. åŠ¨æ€å·¥å…· + å¤šç§Ÿæˆ·éš”ç¦»

å·¥å…·ç³»ç»Ÿé‡‡ç”¨æ³¨å†Œè¡¨æ¨¡å¼ã€‚`web_search` æ˜¯å…¨å±€é™æ€å·¥å…·ï¼Œè€Œ `rag_retrieval` å› ä¸ºéœ€è¦ `tenantId` ä¸Šä¸‹æ–‡ï¼Œé‡‡ç”¨**å·¥å‚å‡½æ•°åŠ¨æ€åˆ›å»º**ï¼š

```typescript
// æ¯æ¬¡è¯·æ±‚åŠ¨æ€åˆ›å»ºï¼Œç¡®ä¿ tenantId éš”ç¦»
const ragTool = createRagRetrievalTool(ragService, tenantId);
```

è¿™æ ·ä¸åŒç§Ÿæˆ·åªèƒ½æ£€ç´¢åˆ°è‡ªå·±çš„çŸ¥è¯†åº“æ•°æ®ã€‚

---

## é¡¹ç›®ç»“æ„

```
nest-agent/
â”œâ”€â”€ src/                       # åç«¯ï¼ˆNestJSï¼‰
â”‚   â”œâ”€â”€ auth/                  # JWT è®¤è¯ + å¤šç§Ÿæˆ·å®ˆå«
â”‚   â”œâ”€â”€ chat/                  # å¯¹è¯ç®¡ç† + SSE æµå¼æ¥å£ + è®°å¿†ç­–ç•¥
â”‚   â”œâ”€â”€ agent/                 # æ ¸å¿ƒï¼šSupervisor è·¯ç”± + DAG å¼•æ“
â”‚   â”‚   â”œâ”€â”€ agent.service.ts   # ç¼–æ’å…¥å£ + AG-UI äº‹ä»¶è½¬æ¢
â”‚   â”‚   â”œâ”€â”€ supervisor.factory.ts  # Supervisor æœ‰å‘å›¾æ„å»º
â”‚   â”‚   â””â”€â”€ dag-engine.ts      # DAG ç¼–è¯‘æ‰§è¡Œå¼•æ“
â”‚   â”œâ”€â”€ rag/                   # RAG çŸ¥è¯†åº“ï¼ˆMilvus å‘é‡æ£€ç´¢ï¼‰
â”‚   â”œâ”€â”€ llm/                   # å¤š LLM ä¾›åº”å•†æŠ½è±¡
â”‚   â”œâ”€â”€ tools/                 # å·¥å…·æ³¨å†Œä¸­å¿ƒ
â”‚   â”œâ”€â”€ redis/                 # Redis ç¼“å­˜
â”‚   â”œâ”€â”€ entities/              # TypeORM å®ä½“
â”‚   â””â”€â”€ common/                # AG-UI åè®®å®šä¹‰ã€é…ç½®ã€å¼‚å¸¸è¿‡æ»¤å™¨
â”œâ”€â”€ web/                       # å‰ç«¯ï¼ˆReact + shadcn/ui + Viteï¼‰
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ pages/             # å¯¹è¯ã€å·¥ä½œæµã€çŸ¥è¯†åº“ã€ç™»å½•
â”‚       â”œâ”€â”€ components/        # å¸ƒå±€ + shadcn/ui ç»„ä»¶
â”‚       â””â”€â”€ lib/               # API å°è£…ã€è®¤è¯ä¸Šä¸‹æ–‡
â”œâ”€â”€ Dockerfile                 # å¤šé˜¶æ®µæ„å»º
â”œâ”€â”€ docker-compose.yml         # MySQL + Redis + Milvus ä¸€é”®å¯åŠ¨
â””â”€â”€ pnpm-workspace.yaml        # monorepo é…ç½®
```

---

## å¿«é€Ÿå¯åŠ¨

### Docker ä¸€é”®éƒ¨ç½²

```bash
git clone https://github.com/peng-yin/nest-agent.git
cd nest-agent
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥ OPENAI_API_KEY ç­‰é…ç½®
docker-compose up -d
# è®¿é—® http://localhost:3000
```

### æœ¬åœ°å¼€å‘

```bash
# 1. å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose up -d mysql redis etcd minio milvus-standalone

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. å¯åŠ¨åç«¯ï¼ˆçƒ­é‡è½½ï¼‰
pnpm dev            # http://localhost:3000

# 4. å¯åŠ¨å‰ç«¯ï¼ˆå¦å¼€ç»ˆç«¯ï¼‰
pnpm dev:web        # http://localhost:5173
```

### ç¯å¢ƒå˜é‡

| å˜é‡ | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `OPENAI_API_KEY` | æ˜¯ | OpenAI API Key |
| `OPENAI_BASE_URL` | å¦ | è‡ªå®šä¹‰ API åœ°å€ï¼ˆå…¼å®¹ SiliconFlow/Deepseekï¼‰ |
| `TAVILY_API_KEY` | å¦ | ç½‘é¡µæœç´¢åŠŸèƒ½éœ€è¦ |
| `JWT_SECRET` | ç”Ÿäº§å¿…å¡« | JWT ç­¾åå¯†é’¥ |

---

## è¸©è¿‡çš„å‘

åˆ†äº«å‡ ä¸ªå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å…¸å‹é—®é¢˜ï¼š

### 1. createReactAgent å­å›¾çš„"æ€è€ƒ"æ–‡æœ¬æ³„éœ²

ä½¿ç”¨ LangGraph çš„ `createReactAgent` æ—¶ï¼Œå†…éƒ¨ LLM åœ¨å†³å®šè°ƒç”¨å·¥å…·å‰ä¼šè¾“å‡ºä¸€æ®µ"æ€è€ƒ"æ–‡æœ¬ã€‚è¿™äº›æ–‡æœ¬é€šè¿‡ `streamEvents` è¢«æ•è·å¹¶å‘é€åˆ°å‰ç«¯ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯ä¸€å † prompt æ¨¡æ¿æ–‡å­—è€Œéå®é™…å›ç­”ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡ `langgraph_checkpoint_ns` ä¸­çš„ `langgraphNode` å’Œ `parentNode` åŒºåˆ†é¡¶å±‚èŠ‚ç‚¹å’Œå­å›¾å†…éƒ¨è°ƒç”¨ã€‚å­å›¾å†…éƒ¨ LLM çš„ `langgraphNode` æ˜¯ `"agent"`ï¼Œè€Œ `parentNode` æ˜¯ `"researcher"`ï¼Œä¸¤è€…ä¸åŒï¼›æ™®é€šé¡¶å±‚èŠ‚ç‚¹ä¸¤è€…ç›¸åŒã€‚åˆ©ç”¨ `langgraphNode !== parentNode` è¯†åˆ«åµŒå¥—è°ƒç”¨ï¼Œå°†å·¥å…·è°ƒç”¨å‰çš„æ–‡æœ¬æš‚å­˜ä¸¢å¼ƒã€‚

### 2. StateGraph èŠ‚ç‚¹çš„ checkpointNs ç†è§£åå·®

æœ€åˆä»¥ä¸ºåªæœ‰ `createReactAgent` æ„å»ºçš„å­å›¾æ‰æœ‰ `checkpointNs`ï¼Œä½†å®é™…ä¸Š StateGraph ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ã€‚å¯¼è‡´ `responder`ï¼ˆç›´æ¥å›ç­”ï¼‰çš„æ­£å¸¸æ–‡æœ¬ä¹Ÿè¢«é”™è¯¯æš‚å­˜ã€‚debug æ—¥å¿—å¤§æ³•å¥½ã€‚

### 3. é˜¿é‡Œäº‘ DashScope çš„ XML å·¥å…·è°ƒç”¨

é€šè¿‡ OpenAI å…¼å®¹ API è°ƒç”¨ qwen æ¨¡å‹æ—¶ï¼Œéƒ¨åˆ†åœºæ™¯ä¸‹å·¥å…·è°ƒç”¨ä¸èµ°æ ‡å‡†çš„ `tool_calls` å­—æ®µï¼Œè€Œæ˜¯åœ¨æ–‡æœ¬ä¸­è¾“å‡º `<tool_call>` XML æ ‡ç­¾ã€‚éœ€è¦æ­£åˆ™æ£€æµ‹å¹¶è¿‡æ»¤ï¼Œå¦åˆ™å‰ç«¯ä¼šæ˜¾ç¤ºä¸€å † XMLã€‚

---

## åç»­è®¡åˆ’

- [ ] æ”¯æŒæ›´å¤šå·¥å…·ï¼ˆä»£ç æ‰§è¡Œã€æ–‡ä»¶ä¸Šä¼ ã€å›¾ç‰‡ç”Ÿæˆç­‰ï¼‰
- [ ] å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨ï¼ˆæ‹–æ‹½å¼ DAG ç¼–è¾‘ï¼‰
- [ ] Agent æ‰§è¡Œè¿‡ç¨‹çš„å¯è§†åŒ– Trace
- [ ] æ”¯æŒæ›´å¤šå‘é‡æ•°æ®åº“ï¼ˆPineconeã€Qdrantï¼‰
- [ ] æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼ˆPDFã€Word ç­‰æ–‡æ¡£ç›´æ¥å…¥åº“ï¼‰

---

## å†™åœ¨æœ€å

è¿™ä¸ªé¡¹ç›®ä»æ¶æ„è®¾è®¡åˆ°ç¼–ç å®ç°ï¼Œå…¨éƒ¨ç”±ä¸€ä¸ªäººå®Œæˆã€‚æ¶µç›–äº† Agent ç¼–æ’ã€æµå¼é€šä¿¡ã€RAG æ£€ç´¢ã€å¤šç§Ÿæˆ·éš”ç¦»ç­‰å¤šä¸ªæŠ€æœ¯é¢†åŸŸï¼Œå¸Œæœ›èƒ½ä¸º Node.js/TypeScript ç”Ÿæ€çš„ AI Agent å¼€å‘æä¾›ä¸€ä¸ªå¯å‚è€ƒçš„å®è·µæ¡ˆä¾‹ã€‚

ä»£ç å®Œå…¨å¼€æºï¼Œå¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæˆ–è€…ä½ å¯¹ NestJS + AI Agent æ„Ÿå…´è¶£ï¼Œæ¬¢è¿ï¼š

- â­ **Star** è¿™ä¸ªé¡¹ç›®ï¼š[GitHub - nest-agent](https://github.com/peng-yin/nest-agent)
- ğŸ› æ Issue æˆ– PRï¼Œä¸€èµ·å®Œå–„
- ğŸ’¬ ç•™è¨€äº¤æµï¼Œåˆ†äº«ä½ çš„æƒ³æ³•

æ„Ÿè°¢é˜…è¯»ï¼
